---
title: 30分で理解するEloquentの巨大な全貌
author: HAYASHI Masayuki
---

# 30分で理解するEloquentの巨大な全貌

HAYASHI Masayuki

<!--

TODO: 最初のあいさつどうする？

-->

<style>
h1, p {
  text-align: center;
}
</style>

---

# Eloquentしっかり理解して使えてますか？

<!--

みなさん、Eloquent, しっかり理解して使えてますか？
Eloquent, 短いコードで、データベースを簡単に扱えて便利ですよね。
簡単なことは簡単にできて、複雑なこともそれなりにできます。
ただ、「本当に」ややこしいことをしようとしたとき、
あるいは逆に細かいことを調べようとしたとき、
なかなか大変だったりしませんか？

-->

---

# 気軽に使えるけど、本当に理解して使うのは難しい

<!--

「気軽に使えるけど、本当に理解して使うのは難しい」
少なくとも私は、しっかり理解して使えているとは言えない状況でした。
ドキュメントに書いてある通りにざっと使う分には、まあ困ることもあまりありません。
が、そこからちょっと外れたとき。
機能によってはコードちょっと追うだけでわかることもありますが、
コードを理解するのがそもそも難しい場合もありました。
気軽に使えるようにするために、Eloquentの中ではいろいろと複雑なことをしているんです。

-->

---

```php
<?php

namespace App\Models;

// これはEloquent\Modelを継承したクラス
use Illuminate\Foundation\Auth\User as Authenticatable;

class User extends Authenticatable
{
    protected $fillable = [
        'name',
        'email',
        'password',
    ];

    // ...
}
```

<!--

実際に私がどういうところで引っかかったか、いくつか事例を紹介します。
これはバージョン<VERSION>での、デフォルトのUserモデルです。
細かいところ端折ってますが。
さて、$fillableというプロパティがあります。
ご存知の通り、ここで指定されているプロパティ以外には一括割り当てができない、
というものです。
TODO: この辺からスライド分けたり？
では具体的にこれは、どこまで有効なのでしょうか？
テスト環境のアカウントのパスワード忘れちゃって、tinkerからupdateでパスワードを変
更しようとしてエラーになった、なんてことは割とみなさんご経験あるんじゃないでしょ
うか。
パスワードは、$fillableに設定されていませんから。
ではcreateでも同様にエラーになるのか。プロパティへの代入で設定してsaveするパター
ンでは？
そもそもEloquentでINSERTする方法はそれだけでしょうか？　すべての方法を知っていま
すか？

-->

---

```php
<?php

# TODO: datesとかがいい？
```

<!--

TODO
アクセサはまあわかる、プロパティにアクセスしたときに多分処理してる。
では、キャストはどうなのか？　アクセサと同様？　違うタイミング？
ミューテタは？
というかあれだ、setしたデータはどの時点でキャスト、ミューテート、されてるかみた
いな。
……いや、即されてるよな。うーん。

-->

---

```php
<?php

$user->posts()->updateOrCreate
```

<!--

TODO
リレーションにクエリとしてアクセスした場合って中ではなにが起こってるの？
リレーション経由でupdateOrCreateしたときに、
？？？
あー、リレーション経由のクエリで、行けるやつと行けないやつあるから、それで。

-->

---

```php
<?php

use App\Models\User;

User::insert([
  ['name' => 'tarou', 'email' => 'tarou@example.com', 'password' => bcrypt('...')],
  ['name' => 'jirou', 'email' => 'jirou@example.com', 'password' => bcrypt('...')],
]);
```

<!--

あるいは、複数行を一気に挿入したくて、insertを使ったら、

-->

---

```tinker
>>> User::all()
=> Illuminate\Database\Eloquent\Collection {#3880
     all: [
       App\Models\User {#4502
         id: 1,
         name: "tarou",
         email: "tarou@example.com",
         email_verified_at: null,
         #password: "$2y$10$cwEulK.T4gTcHuycWBIpXOATx7gQFZqzpxEXqhc2wUb7MqSp51jpW",
         #remember_token: null,
         created_at: null,
         updated_at: null,
       },
       App\Models\User {#4240
         id: 2,
         name: "jirou",
         email: "jirou@example.com",
         email_verified_at: null,
         #password: "$2y$10$AlitastY/2.g.sTzw8EnGuBfrCxoq21Zvc7exttPmn8dE6VEKhRQm",
         #remember_token: null,
         created_at: null,
         updated_at: null,
       },
     ],
   }
```

<!--

ご覧の通り、created_at, updated_atが保存されていません。
なぜでしょう？

-->

---

<!--

こういう感じで引っかかったとき、大抵の場合は該当のメソッドと、関連するいくつかの
メソッドを調べるだけでも答えを得ることはできます。でもそうでない場合もあります。
そういうときでも、しっかりEloquentの全貌を理解していれば、よりスムーズに答えを得
られるのではないかと思います。

-->

---

# このセッションでは

* 巨大で複雑なEloquentの全貌をどうにか理解して、
* Eloquentで複雑なことをしたり細かいことを調べるときに、
* 大変な思いをせず、できるだけ簡単にできるようになる。

<!--

(スライド読む)

-->

---

# そもそもEloquentって本当に「巨大」なの？

* コードの規模の計測は難しい
* とはいえ、大きいか小さいかくらいは、ある程度の共通認識ができそう

<!--

さて、タイトルから始まってずっと、Eloquentは巨大だと話してきました。
ですが実際どうでしょうか？
よく言われる通り、コードの規模の計測は難しいです。
とはいえ規模が大きいか小さいか、くらいであれば、ある程度共通認識を作ることもできそうです。

-->

---

# Eloquentの「範囲」

<!--

規模について考える前にもう一つだけ。
このセッションで話す、「Eloquent」の範囲について、前提となる認識を作りたいと思います。
といっても簡単です。このセッションでは、\Illuminate\Database\Eloquent\Modelを継
承したクラスについて、Eloquentのモデル、として扱い、それをEloquentの範囲としま
す。
つまり、\Illuminate\Database以下でもEloquent以外の名前空間のものや、artisanの
make:modelコマンド、あるいはファクトリは範囲外、ということです。

-->

---

# 数えてみよう

```php
count((new ReflectionClass(new class extends Illuminate\Database\Eloquent\Model {}))->getMethods())
```

これをtinkerで実行してみると、

<!--

さて、それではまず、Eloquentのモデルのメソッド数を数えてみます。
コードの規模を考える上で、いちばん手軽なのはコードの行数ですが、特に比較対象がな
い場合に行数だけから規模を考えるのはなかなか難しい気がするので、もうちょっとマシ
そうな、メソッド数です。
tinkerで、リフレクションを使って特にメソッドを追加していないモデルクラスのメソッ
ド数を数えてみます。
手もとにLaravelを動かせる環境がある人は、ぜひ実際に試してみてください。
バージョンによって違ってはくると思いますが。

-->

---

# 350

<!--

350という数値が出ました。protectedメソッドも含むんですが。
とはいえ、まあ十分多いのではないでしょうか。
仕事で350メソッドもあるクラスを書いたら、多分レビューは通らないと思います。
さて、実際350ってどのくらいでしょう？

-->

---

<!--

(メソッド一覧)

-->

---

<!--

以上です。見るだけでつらい感じになりますね。
これでEloquentが巨大であるということには、ひとまず同意いただけるのではないでしょうか。
なおすでに気付いている人もいると思うんですが、実際にはEloquentには、これ以上のメソッドがあります。

-->

---

<!--

しかし、350あるいはそれ以上のメソッドを、端から端までぜんぶ読むのはちょっと大変そうです。
大変以前に、今日のセッションの時間は30分しかないので、まあ不可能ですね。
ではどうやって、30分でEloquentの全貌を理解しましょう？

-->

---

# ではどうするか？

* 分割して理解する
* 抽象化して把握する

<!--

我々はプログラマなので、大きなもの、複雑なものにどう対処すればいいかは知っています。
分割して少しずつ理解したり、抽象化して大きなものも把握しやすくしたり、
そういう手法をあれこれ使って、なんとかしてきたいと思います。

-->

